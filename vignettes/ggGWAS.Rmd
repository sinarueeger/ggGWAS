---
title: "Plotting GWAS Summary Statistics with ggplot2"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Plotting GWAS Summary Statistics with ggplot2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r setup, include = FALSE}
library(GWAS.utils)
library(ggplot2)
library(ggGWAS)
library(dplyr)
theme_set(theme_bw())
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
requireNamespace("data.table", quietly = TRUE)

```



## Introduction

The two main goals of the `ggGWAS` package is to display GWAS summary statistics within seconds and enable `ggplot2` functionalities for pretty + versatile data visualisation.  



## Data

WHRadjBMI (WHR adjusted for BMI) GWAS summary statistics from Pulit _et al._ (2018) (downloaded from [Zenodo](https://zenodo.org/record/1251813#.XUqYvlCxXUJ) or [here](https://portals.broadinstitute.org/collaboration/giant/index.php/GIANT_consortium_data_files)).


```{r cache = TRUE, echo=TRUE, warning=FALSE, cache = TRUE}
data_whr <- data.table::fread("https://portals.broadinstitute.org/collaboration/giant/images/6/6e/Whradjbmi.giant-ukbb.meta-analysis.combined.23May2018.HapMap2_only.txt.gz") %>% as.data.frame()
data_whr[1:3,]
```


## Q-Q plot



To create a Q-Q plot we can use the function `geom_gwas_qq`.

```{r qqplot-example, fig.height=6, fig.width=6, out.width="40%", echo = FALSE}
ggplot(data = data_whr) + 
  geom_gwas_qq(aes(y = P)) +
  geom_abline(intercept = 0, slope = 1, linetype = 2) + 
  theme(aspect.ratio = 1)

```

You can remove points below a certain p-value threshold with the argument `y.thresh`.

```{r qqplot-example-filter, fig.height=6, fig.width=6, out.width="40%", echo = FALSE, warning = FALSE}
ggplot(data = data_whr) + 
  geom_gwas_qq(aes(y = P), y.thresh = 0.1) + 
  geom_abline(intercept = 0, slope = 1, linetype = 2) + 
  theme(aspect.ratio = 1) + 
  xlim(0, NA) + ylim(0, NA)

```


To enable hexagons, simply add `_hex` to the function `geom_gwas_qq`.

```{r qqplot-example-hex, fig.height=6, fig.width=6, out.width="40%", echo = FALSE}
ggplot(data = data_whr %>% sample_n(1e5)) + 
  geom_gwas_qq_hex(aes(y = P)) + 
  geom_abline(intercept = 0, slope = 1, linetype = 2) + 
  theme(aspect.ratio = 1)
 
```

How does the plot look like among the very large P-values?

```{r qqplot-example-hex-zoom, fig.height=5, fig.width=10, out.width="80%", echo = FALSE, fig.show='hold'}

plot_qq <- ggplot(data = data_whr) + 
  geom_gwas_qq(aes(y = P)) +
  geom_abline(intercept = 0, slope = 1, linetype = 2)

plot_qq_hex <- ggplot(data = data_whr) + 
  geom_gwas_qq_hex(aes(y = P), bins = 100,
  hex.function = ggplot2:::hexBinSummarise) +
  geom_abline(intercept = 0, slope = 1, linetype = 2)

zoom <- plot_qq + 
  coord_cartesian(ylim = c(0, -log10(0.05)), xlim = c(0, -log10(0.05))) 
zoom_hex <- plot_qq_hex + 
  coord_cartesian(ylim = c(0, -log10(0.05)), xlim = c(0, -log10(0.05)))

print(zoom)
print(zoom_hex)

```

Note, that by default, ``geom_gwas_qq_hex`` does not use the default hexagons from `ggplot2`, but a tweaked version. 


We can also apply facetting, for example if you have summary statistics available from multiple GWASs. Note, that the statistics will be computed within each facet or group.

```{r qqplot-example-group, fig.width=11, fig.height = 4, out.width="80%", echo = FALSE}
ggplot(data = data_whr %>% filter(CHR %in% c(1, 5, 6))) + 
  geom_gwas_qq(aes(y = P)) + 
  facet_wrap(~CHR) + 
  geom_abline(intercept = 0, slope = 1, linetype = 2)

```

Any other ggplot functionality can be applied: 

```{r qqplot-example-aes, echo=, fig.height=4, fig.width=11, out.width="80%"}
ggplot(data = data_whr %>% filter(CHR %in% c(1, 5, 6)) %>% mutate(CHR = as.factor(CHR))) + 
  stat_gwas_qq(aes(y = P, color = CHR, group = CHR)) + 
  geom_abline(intercept = 0, slope = 1, linetype = 2)

ggplot(data = data_whr %>% filter(CHR %in% c(1, 5, 6)) %>% mutate(CHR = as.factor(CHR))) + 
  stat_gwas_qq(aes(y = P, color = CHR)) + 
  geom_abline(intercept = 0, slope = 1, linetype = 2)

```

Alternatively, we can achieve a Q-Q plot by using a combination of native `ggplot2` functions and ``ggGWAS::mlog10_trans``. 

```{r qqplot-example-scale, fig.height=6, fig.width=6, out.width="40%", echo = FALSE}
ggplot(data = data_whr) + 
  stat_qq(aes(sample = P), distribution = stats::qunif) +
  scale_y_continuous(trans = "mlog10") + 
  scale_x_continuous(trans = "mlog10") + 
  geom_abline(intercept = 0, slope = 1, linetype = 2) + 
  theme(aspect.ratio = 1)


```


## Manhattan plot

